---
title: "Github ã§ Production ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒ«ãƒªã‚¯è‡ªå‹•ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆã™ã‚‹" # è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«
emoji: "ğŸ¤–" # Choose an appropriate emoji for each article
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢è¨˜äº‹
topics: ["Ruby", "GitHub", "è‡ªå‹•åŒ–", "yml", "GitHubActions"] # ã‚¿ã‚°ã€‚["markdown", "rust", "aws"]ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹
published: true # å…¬é–‹è¨­å®šï¼ˆfalseã«ã™ã‚‹ã¨ä¸‹æ›¸ãï¼‰
---
# ã“ã‚Œãªã«

- ã„ã¤ã‚‚ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒï¼ˆStagingï¼‰ã®ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰æœ¬ç•ªç’°å¢ƒï¼ˆProductionï¼‰ã®ãƒ–ãƒ©ãƒ³ãƒã«è‡ªå‹•çš„ã«PRä½œæˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
- ãŸã ã€ã„ã¤ã‚‚æ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã™ã‚‹éš›ã«è‡ªåˆ†ã§æ¯å›ä½œæˆã—ã¦ã„ã‚‹ã®ãŒé¢å€’ã«ãªã£ã¦ããŸã®ã§ã€å‚™å¿˜éŒ²ã¨ã—ã¦è¨˜äº‹ã«ã—ã¾ã—ãŸã€‚

# æ™‚é–“ãŒãªã„äººå‘ã‘

ã¨ã‚Šã‚ãˆãšå¾¡è¨—ã¯ã„ã‚‰ã­ãˆã€ã£ã¦äººã¯ä»¥ä¸‹ã®ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰ä½•ã‚’ä½œæˆã—ã¦ã„ã‚‹ã‹è¦‹ã¦ãã ã•ã„ã€‚
ã‚ã¨ã¯ Settings ã‹ã‚‰ Github Actions ã«å¯¾ã—ã¦ PR ä½œæˆæ¨©é™ã‚’ä»˜ä¸ã—ãªã„ã¨ã„ã‘ãªã„ã®ã§ã€ãã‚Œã ã‘å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

https://github.com/su3-hokkaido/auto_pr_creator_with_github_actions/commit/a17b156f21276eabda4f097bfaa929ff6b75e2ab

# ä½•ãŒã§ãã‚‹ã‹

ä¾‹ãˆã° develop ãƒ–ãƒ©ãƒ³ãƒã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã€master ãƒ–ãƒ©ãƒ³ãƒã‚’æœ¬ç•ªç’°å¢ƒã«ä½¿ç”¨ã—ã¦ã„ã‚‹ãªã‚‰ã€ develop ãƒ–ãƒ©ãƒ³ãƒã« PR ã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã« master ãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã—ã¦ PR ã‚’ä½œæˆã—ã¦ãã‚Œã¾ã™

![pull request generated by github actions](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2819748/a35f74d1-ae48-4a06-9ca7-3a0d02f78514.png)

![workflow history](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2819748/62e27e1a-5389-47c0-895d-42fb3db9d400.png)

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•

### 1: Github Actions ãŒ PR ä½œæˆã™ã‚‹ã“ã¨ã‚’è¨±å¯ã™ã‚‹

- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ãŸã„ãƒªãƒã‚¸ãƒˆãƒªã§ Settings > Actions > General ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
- `Workflow permissions` ã«ã‚ã‚‹ `Read repository contents and packages permissions` ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹

![allow_github_actions_create_prs.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2819748/29ffe895-603c-4199-819c-72e6a33bcb84.png)

### 2: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ã™ã§ã«å‰è¿°ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è¨˜è¼‰æ¸ˆã¿ã§ã¯ã‚ã‚Šã¾ã™ãŒã€æ”¹ã‚ã¦ãƒªãƒ³ã‚¯ã‚’ã“ã¡ã‚‰ã«è¨˜è¼‰ã—ã¾ã™ã€‚

https://github.com/su3-hokkaido/auto_pr_creator_with_github_actions/commit/a17b156f21276eabda4f097bfaa929ff6b75e2ab

ä½œæˆãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®3ã¤ã§ã™ã€‚

- `.git-pr-release`
- `.github/git-pr-release.erb`
- `.github/workflows/create-d2m-pr.yml`

# å„ãƒ•ã‚¡ã‚¤ãƒ«ã®èª¬æ˜

### `.git-pr-release`

ä¸»ã«å·®åˆ†ã‚’ãƒãƒ¼ã‚¸ã™ã‚‹éš›ã®ã‚½ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’æŒ‡å®šã™ã‚‹è¨­å®šã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™
staging ãŒå…ƒã®ãƒ–ãƒ©ãƒ³ãƒã€ production ãŒãƒãƒ¼ã‚¸å…ˆã®ãƒ–ãƒ©ãƒ³ãƒã§ã™

```
[pr-release "branch"]
    staging = develop
    production = main
[pr-release]
    template = .github/git-pr-release.erb
    labels = git-pr-develop
```

### `.github/git-pr-release.erb`

ä¸»ã« PR ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨˜è¿°ã™ã‚‹ãŸã‚ã®è¨­å®š
1è¡Œç›®ãŒã‚¿ã‚¤ãƒˆãƒ«ã€2è¡Œç›®ä»¥é™ã¯ description ã«ãƒãƒ¼ã‚¸ã™ã‚‹å†…å®¹ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™

```erb
develop-to-main <%= Time.now.strftime("%Y-%m-%d") %>
<% pull_requests.each do |pr| -%>
  <%=  pr.to_checklist_item %>
<% end -%>
```

### `.github/workflows/create-d2m-pr.yml`

ä¸»ã« GitHub Actions ãŒã©ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‹ã€PR ä½œæˆã®ãŸã‚ã®æ¨©é™ä»˜ä¸ãªã©ã€å„ç¨®è¨­å®šã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™
ä»¥ä¸‹ã¯ develop ãƒ–ãƒ©ãƒ³ãƒã® push ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™

```yml
name: Create d2m PR

on:
  push:
    branches:
      - develop

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  d2m-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set up Ruby 3.3.1
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3.1
      - name: Execute gir-pr-develop (develop -> main)
        env:
          GIT_PR_RELEASE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gem install git-pr-release
          git-pr-release || echo "Done."
```

### `.github/CODEOWNERS`

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã¯ä»»æ„ã§ã™ãŒã€GitHub Actions ãŒ PR ã‚’ã‚ªãƒ¼ãƒ—ãƒ³ã™ã‚‹éš›ã«ç‰¹å®šã®ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã®ã‚¢ãƒ—ãƒ«ãƒ¼ãƒ—ã‚’å¿…é ˆã«ã—ãŸã„ã®ã§ã‚ã‚Œã°ã€ãƒ–ãƒ©ãƒ³ãƒãƒ«ãƒ¼ãƒ«è¨­å®šã§åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ä¾¿åˆ©ã§ã™

ã‚‚ã—åˆ©ç”¨ã•ã‚ŒãŸã„æ–¹ã¯ Settings > Rules > Rulesets ã§è¨­å®šã—ã¦ãã ã•ã„
ãªãŠã€æœ¬ä»¶ã«ã¤ã„ã¦ã¯æœ¬è¨˜äº‹ã§æ›¸ããŸã„ã“ã¨ã‹ã‚‰è„±ç·šã™ã‚‹ã®ã§è©³ç´°ã¯å‰²æ„›ã—ã¾ã™

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2819748/4a98cda9-a9fd-4c8f-b602-f5e3627efddd.png)

# æœ€å¾Œã«

ç¢ºã‹ä¼¼ãŸã‚ˆã†ãªè¨˜äº‹ãŒãƒãƒƒãƒˆä¸Šã«å¤§é‡ã«è»¢ãŒã£ã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’å‚ç…§ã—ã¦ã‚‚å…¨ãå•é¡Œã‚ã‚Šã¾ã›ã‚“
ç¹°ã‚Šè¿”ã—ã«ãªã‚Šã¾ã™ãŒã€æœ¬è¨˜äº‹ã¯å€‹äººçš„ãªå‚™å¿˜éŒ²ã¨ã—ã¦è¨˜è¼‰ã—ãŸã ã‘ã§ã™ã‹ã‚‰ã€ã§ã‚‚ãã‚Œã§ã‚‚èª­ã‚“ã§ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ã§ã™

# å‚è€ƒãƒªãƒã‚¸ãƒˆãƒª

https://github.com/su3-hokkaido/auto_pr_creator_with_github_actions
